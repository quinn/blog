<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.45 'Alegreya',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Alegreya',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.75);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.775);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.8);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}ul{margin-left:1.45rem;margin-right:0;margin-top:0.725rem;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.45rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:0.85rem;line-height:1.45rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}blockquote{margin-left:0;margin-right:1.45rem;margin-top:0;padding-bottom:0;padding-left:0.99687rem;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.65);font-style:italic;border-left:0.45313rem solid hsla(0,0%,0%,0.5);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.45rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.45rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}li > ul{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.45rem / 2);}code{font-size:0.85rem;line-height:1.45rem;}kbd{font-size:0.85rem;line-height:1.45rem;}samp{font-size:0.85rem;line-height:1.45rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.96667rem;padding-right:0.96667rem;padding-top:0.725rem;padding-bottom:calc(0.725rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h1,h2,h3,h4,h5,h6{line-height:1;}h1,h2,h3,h4{line-height:1;margin-top:1.45rem;margin-bottom:0.725rem;}h4,h5,h6{text-transformation:uppercase;}a{color:hsl(230,55%,58%);text-decoration:none;}a:hover,a:active{box-shadow:0 1px 0 0 currentColor;}blockquote > :last-child{margin-bottom:0;}@media only screen and (max-width:480px){html{font-size:112.5%;}blockquote{border-left:0.27187rem solid hsla(0,0%,0%,0.5);margin-left:-1.0875rem;margin-right:0;padding-left:0.81563rem;}}a.gatsby-resp-image-link{box-shadow:none;}code[class*="language-"], pre[class*="language-"]{font-size:0.75rem !important;}.gatsby-highlight{margin-bottom:1.45rem;}</style><style data-href="/styles.6d82a24cc2891ca3975f.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 4.1.0"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" title="Your Site&#x27;s RSS Feed" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=ba5aa8a0303a57342488002c0b77539d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=ba5aa8a0303a57342488002c0b77539d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=ba5aa8a0303a57342488002c0b77539d"/><title data-react-helmet="true">Stubbing Rails request with custom Rack env | Quinn&#x27;s Blog</title><meta data-react-helmet="true" name="description" content="There are plenty of tools that provide easy ways to do controller testing in rails, but sometimes in can be nice to test against a specifically built rack env when testing a controller or middleware. Here I dig through some Rails internals to figure out some different ways of doing this.
"/><meta data-react-helmet="true" property="og:title" content="Stubbing Rails request with custom Rack env"/><meta data-react-helmet="true" property="og:description" content="There are plenty of tools that provide easy ways to do controller testing in rails, but sometimes in can be nice to test against a specifically built rack env when testing a controller or middleware. Here I dig through some Rails internals to figure out some different ways of doing this.
"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Quinn Shanahan"/><meta data-react-helmet="true" name="twitter:title" content="Stubbing Rails request with custom Rack env"/><meta data-react-helmet="true" name="twitter:description" content="There are plenty of tools that provide easy ways to do controller testing in rails, but sometimes in can be nice to test against a specifically built rack env when testing a controller or middleware. Here I dig through some Rails internals to figure out some different ways of doing this.
"/><link href="//fonts.googleapis.com/css?family=Alegreya+Sans:500|Alegreya:400,400i,700,700i" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/webpack-runtime-fa180a91d2f6225472d3.js"/><link as="script" rel="preload" href="/framework-07eca8f1d232a1009bf6.js"/><link as="script" rel="preload" href="/app-48201a757ac287e9940c.js"/><link as="script" rel="preload" href="/commons-bd1b7c2ab7ce4539e1e0.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-27c5c7b037ab879c42cc.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-0d1117399e862026c218.js"/><link as="fetch" rel="preload" href="/page-data/2014/04-09-stubbing-rails-request-with-custom-rack/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1091219763.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/63159454.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:43.5rem;padding:2.175rem 1.0875rem"><header><h3 style="margin-top:0"><a href="/">Quinn&#x27;s Blog</a></h3></header><main><article><header><h1 style="margin-top:1.45rem;margin-bottom:0">Stubbing Rails request with custom Rack env</h1><p style="font-size:0.87055rem;line-height:1.45rem;display:block;margin-bottom:1.45rem">April 09, 2014</p></header><section><p>If you are are using the <code class="language-text">rspec-rails</code> gem you should know that there are a
ton of really good ways to test controllers. But, sometimes it can be nice to
have total control over the input that is going to your controller. I’m going
to show you how to construct a request as a rack environment as well as a
request path.</p>
<p>To find a good intersection point for us to build a stub rack environment and
inject it into Rail’s request life-cycle, let’s look at where in the Rails code
the controller get called from the router:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># action_pack/routing/route_set.rb</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">call</span></span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>
  params <span class="token operator">=</span> env<span class="token punctuation">[</span><span class="token constant">PARAMETERS_KEY</span><span class="token punctuation">]</span>

  <span class="token comment"># If any of the path parameters has a invalid encoding then</span>
  <span class="token comment"># raise since it's likely to trigger errors further on.</span>
  params<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>key<span class="token punctuation">,</span> value<span class="token operator">|</span>
    <span class="token keyword">next</span> <span class="token keyword">unless</span> value<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:valid_encoding?</span><span class="token punctuation">)</span>

    <span class="token keyword">unless</span> value<span class="token punctuation">.</span>valid_encoding<span class="token operator">?</span>
      <span class="token keyword">raise</span> <span class="token constant">ActionController</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">BadRequest</span><span class="token punctuation">,</span> <span class="token string">"Invalid parameter: <span class="token interpolation"><span class="token delimiter tag">#{</span>key<span class="token delimiter tag">}</span></span> => <span class="token interpolation"><span class="token delimiter tag">#{</span>value<span class="token delimiter tag">}</span></span>"</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  prepare_params<span class="token operator">!</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

  <span class="token comment"># Just raise undefined constant errors if a controller was specified as default.</span>
  <span class="token keyword">unless</span> controller <span class="token operator">=</span> controller<span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token variable">@defaults</span><span class="token punctuation">.</span>key<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:controller</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'X-Cascade'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'pass'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">end</span>

  dispatch<span class="token punctuation">(</span>controller<span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token symbol">:action</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>Let’s look at the definition of <code class="language-text">controller()</code></p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># If this is a default_controller (i.e. a controller specified by the user)</span>
<span class="token comment"># we should raise an error in case it's not found, because it usually means</span>
<span class="token comment"># a user error. However, if the controller was retrieved through a dynamic</span>
<span class="token comment"># segment, as in :controller(/:action), we should simply return nil and</span>
<span class="token comment"># delegate the control back to Rack cascade. Besides, if this is not a default</span>
<span class="token comment"># controller, it means we should respect the @scope[:module] parameter.</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">controller</span></span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> default_controller<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> params <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>key<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:controller</span><span class="token punctuation">)</span>
    controller_param <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token symbol">:controller</span><span class="token punctuation">]</span>
    controller_reference<span class="token punctuation">(</span>controller_param<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">rescue</span> <span class="token constant">NameError</span> <span class="token operator">=</span><span class="token operator">></span> e
  <span class="token keyword">raise</span> <span class="token constant">ActionController</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">RoutingError</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span> e<span class="token punctuation">.</span>backtrace <span class="token keyword">if</span> default_controller
<span class="token keyword">end</span></code></pre></div>
<p>It’s easy to tell that this the business logic for translating
<code class="language-text">params[:controller] = 'articles'</code> into <code class="language-text">ArticlesController</code>. We can safely
assume that a controller class is now stored in the <code class="language-text">controller</code> variable. Now
let’s look at the definition of <code class="language-text">dispatch()</code>:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">dispatch</span></span><span class="token punctuation">(</span>controller<span class="token punctuation">,</span> action<span class="token punctuation">,</span> env<span class="token punctuation">)</span>
  controller<span class="token punctuation">.</span>action<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">(</span>env<span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>That’s a pretty clean API. If we want to test a specific controller and
action, this would be a great place to intersect. Let’s take a look at that:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">ArticlesController</span><span class="token punctuation">.</span>action<span class="token punctuation">(</span><span class="token symbol">:show</span><span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>This won’t work unfortunately, there is a minimum amount of parameters
necessary to get a request to actually work. This is what I’ve used with some
success:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">ArticlesController</span><span class="token punctuation">.</span>action<span class="token punctuation">(</span><span class="token symbol">:show</span><span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">"rack.input"</span>     <span class="token operator">=</span><span class="token operator">></span> <span class="token constant">StringIO</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"REQUEST_METHOD"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
  <span class="token string">"HTTP_ACCEPT"</span>    <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"text/html"</span><span class="token punctuation">,</span>
  <span class="token string">"HTTP_HOST"</span>      <span class="token operator">=</span><span class="token operator">></span> options<span class="token punctuation">[</span><span class="token symbol">:host</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"rack.session"</span>   <span class="token operator">=</span><span class="token operator">></span> <span class="token constant">Hashie</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Mash</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">,</span>
  <span class="token string">'action_dispatch.cookies'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token constant">Hashie</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Mash</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">,</span>
  <span class="token string">"action_dispatch.request.parameters"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>As you can see, this allows you to stub your own rack environment with the
parameters that work for your scenario. Most of the time this won’t be
necessary with the testing tools that are available but it can be useful every
once and awhile.</p></section><hr style="margin-bottom:1.45rem"/><footer><p><a href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fquinn.io%2F2014%2F04-09-stubbing-rails-request-with-custom-rack%2F" target="_blank" rel="noopener noreferrer">Discuss on Twitter</a> • <a href="https://github.com/quinn/blog/tree/master/content/blog//2014/04-09-stubbing-rails-request-with-custom-rack//index.md" target="_blank" rel="noopener noreferrer">View on GitHub</a></p><hr style="margin-bottom:1.45rem"/><div style="display:flex;margin-bottom:3.625rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.725rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECBQP/xAAXAQEBAQEAAAAAAAAAAAAAAAACAAED/9oADAMBAAIQAxAAAAEyuBWsLJkHWgj/AP/EABsQAAIDAAMAAAAAAAAAAAAAAAECAAMREiEx/9oACAEBAAEFArnZAG2cRLrWYliSluJPY/Z//8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAQ/9oACAEDAQE/AWN//8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAQ/9oACAECAQE/ASd//8QAHBAAAgICAwAAAAAAAAAAAAAAAREAEBIhMUFR/9oACAEBAAY/AhiV1BNgxcDyhk3WwK//xAAcEAADAAIDAQAAAAAAAAAAAAAAAREhMVFhcbH/2gAIAQEAAT8ha9rdMxD+iY3l0olRpihWPGQKrHA96V8FNw10YF4P/9oADAMBAAIAAwAAABDQwD//xAAZEQADAAMAAAAAAAAAAAAAAAAAAREQMVH/2gAIAQMBAT8QhVE8w9n/xAAYEQACAwAAAAAAAAAAAAAAAAAAARAhMf/aAAgBAgEBPxC0lh//xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMUFRYZGh/9oACAEBAAE/EGr0YdiPqLaiuRyXsiyizS1AuH3sdszibwm4mwCvfzGIV7VaFm0sYU3CJGcfrP/Z" alt="Quinn Shanahan" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/23971e2c7e6e460d7ec2556a73d79eec/93bd4/profile-pic.jpg 1x,
/static/23971e2c7e6e460d7ec2556a73d79eec/9d3fa/profile-pic.jpg 1.5x,
/static/23971e2c7e6e460d7ec2556a73d79eec/c2440/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/23971e2c7e6e460d7ec2556a73d79eec/93bd4/profile-pic.jpg 1x,
/static/23971e2c7e6e460d7ec2556a73d79eec/9d3fa/profile-pic.jpg 1.5x,
/static/23971e2c7e6e460d7ec2556a73d79eec/c2440/profile-pic.jpg 2x" src="/static/23971e2c7e6e460d7ec2556a73d79eec/93bd4/profile-pic.jpg" alt="Quinn Shanahan" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Quinn Shanahan</strong> who lives and works in NYC<br/><a href="https://twitter.com/quinnshanahan">Twitter</a> | <a href="https://github.com/quinn">Github</a> | <a href="https://instagram.com/qshan">Instagram</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:nowrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2014/04-04-experiments-with-docker/">← <!-- -->Experiments with Docker</a></li><li><a rel="next" href="/2014/04-14-postgresql-array-and-hstore-column-reference/">Postgresql Array and Hstore Column Reference<!-- --> →</a></li></ul></nav></main><footer><div style="float:right"><a href="/rss.xml" target="_blank" rel="noopener noreferrer">rss</a></div>© <!-- -->2022<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-157532376-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2014/04-09-stubbing-rails-request-with-custom-rack/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-eda371cea4b37a3ecbfd.js"],"app":["/app-48201a757ac287e9940c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-9409a7ffd28f0cb3922f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-e2058424a3d3d5e19721.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-0d1117399e862026c218.js"]};/*]]>*/</script><script src="/polyfill-eda371cea4b37a3ecbfd.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-0d1117399e862026c218.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-27c5c7b037ab879c42cc.js" async=""></script><script src="/commons-bd1b7c2ab7ce4539e1e0.js" async=""></script><script src="/app-48201a757ac287e9940c.js" async=""></script><script src="/framework-07eca8f1d232a1009bf6.js" async=""></script><script src="/webpack-runtime-fa180a91d2f6225472d3.js" async=""></script></body></html>