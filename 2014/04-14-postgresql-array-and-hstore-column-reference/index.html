<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.45 'Alegreya',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Alegreya',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.75);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.775);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.8);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Alegreya Sans',sans-serif;font-weight:500;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}ul{margin-left:1.45rem;margin-right:0;margin-top:0.725rem;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.45rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:0.85rem;line-height:1.45rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}blockquote{margin-left:0;margin-right:1.45rem;margin-top:0;padding-bottom:0;padding-left:0.99687rem;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.65);font-style:italic;border-left:0.45313rem solid hsla(0,0%,0%,0.5);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.45rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.45rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}li > ul{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.45rem / 2);}code{font-size:0.85rem;line-height:1.45rem;}kbd{font-size:0.85rem;line-height:1.45rem;}samp{font-size:0.85rem;line-height:1.45rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.96667rem;padding-right:0.96667rem;padding-top:0.725rem;padding-bottom:calc(0.725rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h1,h2,h3,h4,h5,h6{line-height:1;}h1,h2,h3,h4{line-height:1;margin-top:1.45rem;margin-bottom:0.725rem;}h4,h5,h6{text-transformation:uppercase;}a{color:hsl(230,55%,58%);text-decoration:none;}a:hover,a:active{box-shadow:0 1px 0 0 currentColor;}blockquote > :last-child{margin-bottom:0;}@media only screen and (max-width:480px){html{font-size:112.5%;}blockquote{border-left:0.27187rem solid hsla(0,0%,0%,0.5);margin-left:-1.0875rem;margin-right:0;padding-left:0.81563rem;}}a.gatsby-resp-image-link{box-shadow:none;}code[class*="language-"], pre[class*="language-"]{font-size:0.75rem !important;}.gatsby-highlight{margin-bottom:1.45rem;}</style><meta data-react-helmet="true" name="description" content="I&#x27;ve had trouble finding a good reference for hstore and arrays in postgres that includes examples and use-cases so I decided to put together my own here. Hopefully others can get some use out of it. I&#x27;ve also included some examples of how to use with ActiveRecord.
"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=ca168147c4c8b8710384154e8ca04d6d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=ca168147c4c8b8710384154e8ca04d6d"/><title data-react-helmet="true">Postgresql Array and Hstore Column Reference | Quinn&#x27;s Blog</title><meta name="generator" content="Gatsby 2.19.7"/><meta data-react-helmet="true" property="og:title" content="Postgresql Array and Hstore Column Reference"/><meta data-react-helmet="true" property="og:description" content="I&#x27;ve had trouble finding a good reference for hstore and arrays in postgres that includes examples and use-cases so I decided to put together my own here. Hopefully others can get some use out of it. I&#x27;ve also included some examples of how to use with ActiveRecord.
"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Quinn Shanahan"/><meta data-react-helmet="true" name="twitter:title" content="Postgresql Array and Hstore Column Reference"/><meta data-react-helmet="true" name="twitter:description" content="I&#x27;ve had trouble finding a good reference for hstore and arrays in postgres that includes examples and use-cases so I decided to put together my own here. Hopefully others can get some use out of it. I&#x27;ve also included some examples of how to use with ActiveRecord.
"/><style data-href="/styles.493e6315ef3a09bc2f74.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><link href="//fonts.googleapis.com/css?family=Alegreya+Sans:500|Alegreya:400,400i,700,700i" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-06edd4d3db3f9517a8dc.js"/><link as="script" rel="preload" href="/commons-e0ab5437313eaadf34d8.js"/><link as="script" rel="preload" href="/app-065c9ad85cdd1bcc0947.js"/><link as="script" rel="preload" href="/styles-5b24e9d901ec094b02ef.js"/><link as="script" rel="preload" href="/webpack-runtime-54aa9decc7c8169fd2b9.js"/><link as="fetch" rel="preload" href="/page-data/2014/04-14-postgresql-array-and-hstore-column-reference/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:43.5rem;padding:2.175rem 1.0875rem"><header><h3 style="margin-top:0"><a href="/">Quinn&#x27;s Blog</a></h3></header><main><article><header><h1 style="margin-top:1.45rem;margin-bottom:0">Postgresql Array and Hstore Column Reference</h1><p style="font-size:0.87055rem;line-height:1.45rem;display:block;margin-bottom:1.45rem">April 14, 2014</p></header><section><p>First of all, let’s start with links to the relevant postgres docs:</p>
<p><a href="http://www.postgresql.org/docs/9.3/static/hstore.html">http://www.postgresql.org/docs/9.3/static/hstore.html</a>
<br>
<a href="http://www.postgresql.org/docs/9.3/static/arrays.html">http://www.postgresql.org/docs/9.3/static/arrays.html</a>
<br>
<a href="http://www.postgresql.org/docs/9.3/static/functions-array.html">http://www.postgresql.org/docs/9.3/static/functions-array.html</a></p>
<p>The postgres project has excellent documentation, and these links do covere
everything you would need to work with hstore and arrays with postgres.
Sometimes though it can be difficult to translate their examples into real
world examples, and it can also be difficult to translate this into
ActiveRecord.</p>
<h3>Postgresql Arrays</h3>
<p>Arrays in postgres in that they aren’t their own type per se, rather than it’s
own separate type. Rather, the existing column types can be declared as an
array (e.g. an array of ints, array of texts, etc).</p>
<h3>Declaring array fields</h3>
<p>Arrays can be declared in the following ways:</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> articles <span class="token punctuation">(</span>body <span class="token keyword">text</span><span class="token punctuation">,</span> tags <span class="token keyword">text</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">create_table <span class="token symbol">:articles</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
  t<span class="token punctuation">.</span>text <span class="token symbol">:body</span>
  t<span class="token punctuation">.</span>text <span class="token symbol">:tags</span><span class="token punctuation">,</span> array<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token keyword">end</span></code></pre></div>
<p>That’s pretty straightforward. I’m going to go through some common operations.</p>
<h3>Array inclusion</h3>
<p>Sometimes you want to find out if an array includes, or does not include a
given value, and return the records where it is true. Given the above table,
this is what that could look like:</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token comment">--- which articles are tagged with 'programming'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">WHERE</span> <span class="token string">'programming'</span> <span class="token operator">=</span> <span class="token keyword">ANY</span> <span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">--- which articles are not tagged with 'programming'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">WHERE</span> <span class="token string">'programming'</span> <span class="token operator">!=</span> <span class="token keyword">ALL</span> <span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--- or</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">WHERE</span> <span class="token operator">NOT</span> <span class="token punctuation">(</span><span class="token string">'programming'</span> <span class="token operator">=</span> <span class="token keyword">ANY</span> <span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># which articles are tagged with 'programming'</span>
<span class="token constant">Article</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">'? = ANY (tags)'</span><span class="token punctuation">,</span> <span class="token string">'programming'</span><span class="token punctuation">)</span>

<span class="token comment"># which articles are not tagged with 'programming'</span>
<span class="token constant">Article</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">'? != ALL (tags)'</span><span class="token punctuation">,</span> <span class="token string">'programming'</span><span class="token punctuation">)</span>
<span class="token comment"># or</span>
<span class="token constant">Article</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">'NOT (? = ANY (tags))'</span><span class="token punctuation">,</span> <span class="token string">'programming'</span><span class="token punctuation">)</span></code></pre></div>
<h3>Updating arrays</h3>
<p>How do you append to an array? You could use your ORM in a predictable way:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">article <span class="token operator">=</span> <span class="token constant">Article</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
article<span class="token punctuation">.</span>tags <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token string">'programming'</span>
article<span class="token punctuation">.</span>save<span class="token operator">!</span></code></pre></div>
<blockquote>
<p><strong>Note (2014-04-16)</strong>: There may be currently a bug in rails that can cause
issues with the above syntax. If so, try running <code class="language-text">article.tags_will_change!</code>.
More info on the bug <a href="https://github.com/rails/rails/issues/6127">here</a>. Thanks, <a href="http://www.komendera.com/">Dieter Komendera</a> for
pointing this out.</p>
</blockquote>
<p>But what if you wanted to perform this in a single operation, or what if you
wanted to perform this on multiple records at once in a single query? This is
possible, using the <code class="language-text">append_array</code> function:</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">UPDATE</span> articles <span class="token keyword">SET</span> tags <span class="token operator">=</span> array_append<span class="token punctuation">(</span>tags<span class="token punctuation">,</span> <span class="token string">'programming'</span><span class="token punctuation">)</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">Article</span><span class="token punctuation">.</span>update_all <span class="token constant">Article</span><span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token symbol">:sanitize_sql</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'tags = array_append(tags, ?)'</span><span class="token punctuation">,</span> <span class="token string">'programming'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>This unfortunately isn’t as clean as one might like it to be in ActiveRecord.
I’d love to know if there is a better way to do this.</p>
<h3>Find empty arrays</h3>
<p>Generally when creating an array column I think it is advisable to to make it
non-null and default to an empty array:</p>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">t<span class="token punctuation">.</span>text <span class="token symbol">:tags</span><span class="token punctuation">,</span> array<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre></div>
<p>This prevents a small “gotcha” when an array column is null (not an empty
array). For example, in the example above that tests for a value not being in
the array field, the query would have returned a misleading empty set if all
of the array columns were null. You can get around this by setting a column
default, or by testing to see if the array column is null:</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">where</span> <span class="token string">'programming'</span> <span class="token operator">!=</span> <span class="token keyword">ALL</span> <span class="token punctuation">(</span>tags<span class="token punctuation">)</span> <span class="token operator">||</span> tags <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></div>
<p>If you wanted to find all records with empty tags <em>and</em> null tags, you could do:</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">where</span> tags <span class="token operator">=</span> <span class="token string">'{}'</span> <span class="token operator">OR</span> tags <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre></div>
<h3>Array intersection</h3>
<p>It’s a common scenario to want to find records with an array field that has at
least one member from a given list. You can use the <code class="language-text">&amp;&amp;</code> operator to find
these:</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">WHERE</span> tags <span class="token operator">&amp;&amp;</span> ARRAY<span class="token punctuation">[</span><span class="token string">'devops'</span><span class="token punctuation">,</span> <span class="token string">'design'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">--- or, if your array column is of something other than text (possibly varchar)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> articles <span class="token keyword">WHERE</span> CAST <span class="token punctuation">(</span>tags <span class="token keyword">as</span> <span class="token keyword">text</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ARRAY<span class="token punctuation">[</span><span class="token string">'devops'</span><span class="token punctuation">,</span> <span class="token string">'design'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">Article</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">'tags &amp;&amp; ARRAY[?]'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'devops'</span><span class="token punctuation">,</span> <span class="token string">'design'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<h3>Postgresql Hstore</h3>
<p>Postgres hstore is column type for storing hierarchical schemaless data
(sometimes called “documents”) in a Postgres table. This is great if you are
going to be storing data you’d like to be able to query, but aren’t necessarily
going to have consistent field names. Hstore is often compared to NoSQL
document stores such as MongoDB.</p>
<h3>Declaring Hstore column type</h3>
<p><code class="language-text">hstore</code> is just a column type like any other, so declaring it is
straightforward.</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> web_requests <span class="token punctuation">(</span>
  url <span class="token keyword">varchar</span><span class="token punctuation">,</span>
  body <span class="token keyword">text</span><span class="token punctuation">,</span>
  headers hstore
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">create_table <span class="token symbol">:web_requests</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
  t<span class="token punctuation">.</span>string <span class="token symbol">:url</span>
  t<span class="token punctuation">.</span>text <span class="token symbol">:body</span>
  t<span class="token punctuation">.</span>hstore <span class="token symbol">:headers</span>
<span class="token keyword">end</span></code></pre></div>
<h3>Setting a value to a key in hstore</h3>
<p>Hstore keys are strings, and one of two types can be assigned to a key in
hstore: a string, or another hstore value.</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> web_requests <span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>
  <span class="token string">'/articles.json'</span><span class="token punctuation">,</span>
  <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token string">'Accept        => application/json,
   Cache-Control => no-cache'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby">web_request <span class="token operator">=</span> <span class="token constant">WebRequest</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token punctuation">:</span> <span class="token string">'/articles.json'</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Accept'</span>        <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
    <span class="token string">'Cache-Control'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'no-cache'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h3>Finding a record with an hstore with a given value</h3>
<p>These are examples of how to find records that have a key with a given value
for an hstore column.</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> web_requests <span class="token keyword">WHERE</span> headers<span class="token operator">-</span><span class="token operator">></span><span class="token string">'Accept'</span> <span class="token operator">=</span> <span class="token string">'application/json'</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">WebRequest</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">"headers->'Accept' = ?"</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span></code></pre></div>
<h3>Finding a record with an hstore with a non-null value for a given key</h3>
<p>Sometimes you want to find all records that have any value set for a given
key. Using our <code class="language-text">WebRequest</code> example this could be useful for finding all
requests that set caching headers. Postgresql provides a <code class="language-text">defined</code> function
for this.</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> web_requests <span class="token keyword">WHERE</span> defined<span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'Cache-Control'</span><span class="token punctuation">)</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">WebRequest</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">'defined(headers, ?)'</span><span class="token punctuation">,</span> <span class="token string">'Cache-Control'</span><span class="token punctuation">)</span></code></pre></div>
<h3>Removing a key from an hstore</h3>
<p>Rather than setting a key to an empty string or <code class="language-text">NULL</code>, sometimes it can be
nice to completely remove the value and key from hstore. Postgresql provides a
<code class="language-text">delete</code> function to this. Again, I am not aware of a clean interface for
running functions in an <code class="language-text">UPDATE</code> while using ActiveRecord, so I’m using the
same hacky solution described previously for <code class="language-text">append_array</code>.</p>
<h4>SQL</h4>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">UPDATE</span> articles <span class="token keyword">SET</span> headers <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">'Cache-Control'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span></code></pre></div>
<h4>ActiveRecord</h4>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token constant">Article</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update_all <span class="token constant">Article</span><span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token symbol">:sanitize_sql</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'headers = delete(headers, ?)'</span><span class="token punctuation">,</span> <span class="token string">'Cache-Control'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>That’s all for now. Hopefully this helps clarify some ways of using arrays and
hstore especially in practice, and when using ActiveRecord. Stay tuned for
more snippets as well as examples of using postgres’s enum functionality in
ActiveRecord.</p></section><hr style="margin-bottom:1.45rem"/><footer><p><a href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fquinn.io%2F2014%2F04-14-postgresql-array-and-hstore-column-reference%2F" target="_blank" rel="noopener noreferrer">Discuss on Twitter</a> • <a href="https://github.com/quinn/blog/tree/master/content/blog//2014/04-14-postgresql-array-and-hstore-column-reference//index.md" target="_blank" rel="noopener noreferrer">View on GitHub</a></p><hr style="margin-bottom:1.45rem"/><div style="display:flex;margin-bottom:3.625rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.725rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECBQP/xAAXAQEBAQEAAAAAAAAAAAAAAAACAAED/9oADAMBAAIQAxAAAAEyuBWsLJkHWgj/AP/EABoQAAIDAQEAAAAAAAAAAAAAAAECAAMRMRL/2gAIAQEAAQUCudkAbZ5EutZiWJKW4k7H7//EABYRAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAwEBPwFjf//EABYRAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAgEBPwEnf//EAB0QAQABAwUAAAAAAAAAAAAAAAERABAhAhIxQVH/2gAIAQEABj8CHQx1RWRqODyxumbZC3//xAAdEAADAAICAwAAAAAAAAAAAAAAAREhMVFxQWGx/9oACAEBAAE/Ia+LdMdB/SjeTSiVHkVCx0yBVY4HvSvQpumvRkl4P//aAAwDAQACAAMAAAAQ0MA//8QAGREAAwADAAAAAAAAAAAAAAAAAAEREDFR/9oACAEDAQE/EIVRPMPZ/8QAGBEAAgMAAAAAAAAAAAAAAAAAACEBEDH/2gAIAQIBAT8QYSow/8QAHRABAAIDAAMBAAAAAAAAAAAAAQARITFRQWGRof/aAAgBAQABPxByFGHYj8mEqulsvSD3KdLUC4eTp1lxlvhNxdgNe/uMQr2oULA1pGFNwjRx+s//2Q==" alt="Quinn Shanahan" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/23971e2c7e6e460d7ec2556a73d79eec/93bd4/profile-pic.jpg 1x,
/static/23971e2c7e6e460d7ec2556a73d79eec/9d3fa/profile-pic.jpg 1.5x,
/static/23971e2c7e6e460d7ec2556a73d79eec/c2440/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/23971e2c7e6e460d7ec2556a73d79eec/93bd4/profile-pic.jpg 1x,
/static/23971e2c7e6e460d7ec2556a73d79eec/9d3fa/profile-pic.jpg 1.5x,
/static/23971e2c7e6e460d7ec2556a73d79eec/c2440/profile-pic.jpg 2x" src="/static/23971e2c7e6e460d7ec2556a73d79eec/93bd4/profile-pic.jpg" alt="Quinn Shanahan" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Quinn Shanahan</strong> who lives and works in NYC<br/><a href="https://twitter.com/quinnshanahan">Twitter</a> | <a href="https://github.com/quinn">Github</a> | <a href="https://instagram.com/qshan">Instagram</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:nowrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2014/04-09-stubbing-rails-request-with-custom-rack/">← <!-- -->Stubbing Rails request with custom Rack env</a></li><li><a rel="next" href="/2014/04-19-log-nginx-to-stdout-and-stderr-when-run/">Log to STDOUT and STDERR when Running NGINX in the Foreground<!-- --> →</a></li></ul></nav></main><footer><div style="float:right"><a href="/rss.xml" target="_blank" rel="noopener noreferrer">rss</a></div>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-157532376-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2014/04-14-postgresql-array-and-hstore-column-reference/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-065c9ad85cdd1bcc0947.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-06edd4d3db3f9517a8dc.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a2f8b45d223d87b6d480.js"],"component---src-pages-index-js":["/component---src-pages-index-js-fbcba1dde563790cc3e0.js"]};/*]]>*/</script><script src="/webpack-runtime-54aa9decc7c8169fd2b9.js" async=""></script><script src="/styles-5b24e9d901ec094b02ef.js" async=""></script><script src="/app-065c9ad85cdd1bcc0947.js" async=""></script><script src="/commons-e0ab5437313eaadf34d8.js" async=""></script><script src="/component---src-templates-blog-post-js-06edd4d3db3f9517a8dc.js" async=""></script></body></html>