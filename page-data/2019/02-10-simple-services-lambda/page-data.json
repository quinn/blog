{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019/02-10-simple-services-lambda/","result":{"data":{"site":{"id":"Site","siteMetadata":{"title":"Quinn's Blog"}},"markdownRemark":{"id":"c8f81c66-2c2f-5c8b-9b94-cafd2859cd0d","excerpt":"Functional demo can be found here: GitHub — quinn/lambda-nodejs-example Here’s a process for creating simple backends for a web client app. Use cases would be…","html":"<p><em>Functional demo can be found here: <a href=\"https://github.com/quinn/lambda-nodejs-example\">GitHub — quinn/lambda-nodejs-example</a></em></p>\n<p>Here’s a process for creating simple backends for a web client app. Use cases would be when you would like to add a small piece of functionality that doesn’t have much interaction with the rest of the app, but don’t want the overhead that comes with standing up a server.</p>\n<h2>API Gateway Models</h2>\n<p>A lot of articles on this topic using <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-model.html\">AWS API Gateway Models</a>. This is probably helpful if you are building a full-sized REST API around well defined resources, which wasn’t really my use case (small, independent/unrelated behavior). I’m interested in learning more about this but (for now) I’ll probably continue using ruby / node / python app server on VPS (e.g. EC2) for this type of thing.</p>\n<h2>CloudFormation</h2>\n<p>Since using Lambda was new to me I wanted to make sure I could easily replicate the process so I decided to use CloudFormation to preserve the configuration and make it easy to replicate. It sucks figuring out something in the AWS console and then not really remembering the exact steps to recreate it. CloudFormation isn’t the only way to get this working, but it helped me a lot while learning the ins-and-outs of Lambda + API Gateway.</p>\n<h2>Application Structure</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/c6e28/diagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.14406302757456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAABiUlEQVQoz42ROXPcMAyF9f/bFG7yC9ylzSRNXGfijOONd3L6kLXiHiRFkQAJHiElSyt77HHevIKS8IECXqVFzX6fO/AxUAz+GceYUnLect5CB+QpTapsf5DtH77bBwfBYiSM3gWHkyEO1SF6g5q1TPUqP44dqxTIKAIlHWAK2EvU8pDPM597zdWzJjjG9nZ9/vEEeorWbf7++vLhDfT2yc1j9dziAQ6ONjVbX6wMN8HY5oatLy/7rY7+P24OhB6t40gaAqA1uhMikk/epoxlR58eKw4qcCRLoIFzZ7CcUe9YI/lW7EczyQ/dIKWUFKKX6rjt3Gd7P81M5T+9BQd6ck8WvfdEBPk9BiWUIxfIeqQqOceu765W31DDCJc5yR49zLwX7N2nk6bebe5ZfXtdv3+rm21VSp31lpbxPM65wILtv69XQigpRdM0Nz+vjNFlYWPRc+Rx21mqM5zn2eUcW4btS9gy53K5OCC4ZWZlYa87Jeh4e3aqFS3jrtKrGmDVyR9fP6PWyy//ADDGK9BwOr0DAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Diagram\"\n        title=\"Diagram\"\n        src=\"/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/fcda8/diagram.png\"\n        srcset=\"/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/12f09/diagram.png 148w,\n/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/e4a3f/diagram.png 295w,\n/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/fcda8/diagram.png 590w,\n/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/efc66/diagram.png 885w,\n/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/c83ae/diagram.png 1180w,\n/static/724dd7f7c52a1ebf4b0ea1f75c1602fd/c6e28/diagram.png 1777w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<small><center>\n<em>Diagram of CloudFormation Template generated by <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer.html\">Designer</a></em></p>\n</center></small>\n<p>This configuration creates the simplest possible setup that I could figure out for a web client. There are two routes:</p>\n<ul>\n<li>\n<p><code class=\"language-text\">POST /</code>: This is connected to the lambda function. API Gateway passes information about\nthe request as arguments to the lambda function. The function returns an object which\ncontains information on how the http response should be structured, e.g:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n   body: &quot;Content for the HTTP Body&quot;,\n   statusCode: 200, // or any other status code\n   headers: {\n       &quot;Content-Type&quot;: &quot;text/plain&quot;,\n       // etc, more headers\n   },\n}</code></pre></div>\n</li>\n<li><code class=\"language-text\">OPTIONS /</code>: The second route is on the same path but receives on an OPTIONS request. It\nsimply responds with the most permissive CORS possible. In a larger app, you could\nconfigure your own CORS API handler to do something more sophisticated, e.g. returning the\nappropriate headers to enforce a whitelist of allowed domains.</li>\n</ul>\n<p>Here is the resource definition that attaches API Gateway to Lambda:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">\"apiGatewayRootMethod\"</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>ApiGateway<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Method\n  <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">AuthorizationType</span><span class=\"token punctuation\">:</span> NONE\n    <span class=\"token key atrule\">HttpMethod</span><span class=\"token punctuation\">:</span> POST\n    <span class=\"token key atrule\">ResourceId</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!GetAtt</span> <span class=\"token string\">\"restApi.RootResourceId\"</span>\n    <span class=\"token key atrule\">RestApiId</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> <span class=\"token string\">\"restApi\"</span>\n    <span class=\"token key atrule\">Integration</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">IntegrationHttpMethod</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"POST\"</span>\n      <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AWS_PROXY\"</span>\n      <span class=\"token key atrule\">Uri</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Sub</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">lambdaArn</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!GetAtt</span> <span class=\"token string\">\"lambdaFunction.Arn\"</span></code></pre></div>\n<p>In the above resource it is referencing a Lambda function resource named lambdaFunction. See the last line where this reference is created. And the other major piece, the resource definition for the Lambda function:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">\"lambdaFunction\"</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AWS::Lambda::Function\"</span>\n  <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Code</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">S3Bucket</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> bucketName\n      <span class=\"token key atrule\">S3Key</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> bucketKey\n    <span class=\"token key atrule\">FunctionName</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> <span class=\"token string\">\"lambdaFunctionName\"</span>\n    <span class=\"token key atrule\">Handler</span><span class=\"token punctuation\">:</span> index.handler\n    <span class=\"token key atrule\">MemorySize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">128</span>\n    <span class=\"token key atrule\">Role</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!GetAtt</span> <span class=\"token string\">\"lambdaIAMRole.Arn\"</span>\n    <span class=\"token key atrule\">Runtime</span><span class=\"token punctuation\">:</span> nodejs8.10\n    <span class=\"token key atrule\">Timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span></code></pre></div>\n<p>This simply takes as parameters the bucket name and bucket key and loads the zip file located there. Nodejs package managers load all dependencies relative to the project (in <code class=\"language-text\">node_modules</code>) it is very straightforward to create a standalone bundle. See the repo for an example of how to do this.</p>\n<h2>Caveats</h2>\n<p>The main caveat that I found was that CloudFormation only <em>updates configuration</em>. So, certain things may require manual intervention after the stack has been deployed. Updates to the lambda function code seem to be available immediately. However, API Gateway has it’s own “deploy” process which must be ran for any changes to the API Gateway. Typically, changes will probably be with the function code rather than the API structure, so this doesn’t seem like a huge inconvenience. Ideally I’d like to figure out a way to automate this as well.</p>\n<hr>\n<p>This is a “beginner” post, so let me know if what you think and if I missed anything!</p>","fields":{"slug":"/2019/02-10-simple-services-lambda/"},"frontmatter":{"title":"Create simple services for web clients using API Gateway, CloudFormation, and Lambda","date":"February 10, 2019","description":null}}},"pageContext":{"slug":"/2019/02-10-simple-services-lambda/","previous":{"fields":{"slug":"/2017/12-06-setting-up-docker-compose-for-development/"},"frontmatter":{"title":"Setting up Docker Compose for Development"}},"next":{"fields":{"slug":"/2020/02-02-gatsby-and-gh-pages/"},"frontmatter":{"title":"Create a Blog With Github Pages and Gatsby"}}}}}