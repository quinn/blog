{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2021/11-26-compiler-parser/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Quinn's Blog"}},"markdownRemark":{"id":"acdf77cb-c8a5-52aa-84d5-855912327183","excerpt":"I’ve worked a bit more on the compiler, implementing the parsing and code generation steps. So, the program to compile is as follows: Disclaimer: If you are…","html":"<p>I’ve worked a bit more on the compiler, implementing the parsing and code generation steps. So, the program to compile is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<p><strong>Disclaimer</strong>: If you are interested in doing this yourself, I would recommend reading <a href=\"https://norasandler.com/2017/11/29/Write-a-Compiler.html\">Nora Sandler’s blog posts</a>. I’m providing the source code that I ended up with, whereas the instructions found in the blog posts provides good context and instructions without providing any actual code or being prescriptive about the implementation.</p>\n<hr>\n<p>You can see the code I wrote for the lexer <a href=\"/2021/11-20-compiler-lexer\">here</a>. I’ve learned that the lexer actually performs a relatively simple task (compared to the other steps) in that it simply creates a list of tokens. It doesn’t provide any structure or try to find syntax errors.</p>\n<p>The next step is to build the Abstract Syntax Tree (AST) based on the list of tokens. This is where the program gets it’s hiarchical structure. In order to create an AST, each node can be described a combination of tokens or specific kinds of other nodes. For example, a “function” node would be a combination of keywords for return type, tokens for opening and closing brackets, expressions for arguments, statements for the function body, etc. Things like expressions and statements are also nodes, which have their own parsing rules, including tokens and further nodes. As the tokens are parsed, a tree is created as nodes become nested.</p>\n<p>Again, each node is handled differently. For the 3-line example program, there are four types of nodes:</p>\n<ul>\n<li>Program (the toplevel node)</li>\n<li>Function (a single <code class=\"language-text\">main</code> function)</li>\n<li>Statement (a single <code class=\"language-text\">return</code> statement)</li>\n<li>Expression (a single constant value integer)</li>\n</ul>\n<p>As far as code goes, here’s what I got. Still goin’ strong with the ruby.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># frozen_string_literal: true</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ParseError</span> <span class=\"token operator\">&lt;</span> StandardError<span class=\"token punctuation\">;</span> <span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span>\n  attr_reader <span class=\"token symbol\">:tokens</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">initialize</span></span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">@tokens</span> <span class=\"token operator\">=</span> tokens\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Program</span> <span class=\"token operator\">&lt;</span> Node\n  attr_reader <span class=\"token symbol\">:function</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">parse</span></span><span class=\"token operator\">!</span>\n    <span class=\"token variable\">@function</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Function</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parse<span class=\"token operator\">!</span>\n\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'root function must be called main, found %s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@function</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token variable\">@function</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">!=</span> <span class=\"token string-literal\"><span class=\"token string\">'main'</span></span>\n\n    <span class=\"token keyword\">self</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Statement</span> <span class=\"token operator\">&lt;</span> Node\n  attr_reader <span class=\"token symbol\">:is_return</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:expression</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">parse</span></span><span class=\"token operator\">!</span>\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n\n    <span class=\"token keyword\">if</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">KEYWORD</span> <span class=\"token operator\">&amp;&amp;</span> token<span class=\"token punctuation\">.</span>value <span class=\"token operator\">==</span> <span class=\"token string-literal\"><span class=\"token string\">'return'</span></span>\n      <span class=\"token variable\">@is_return</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">else</span>\n      tokens<span class=\"token punctuation\">.</span>unshift<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token variable\">@expression</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Expression</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parse<span class=\"token operator\">!</span>\n\n    <span class=\"token keyword\">self</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Expression</span> <span class=\"token operator\">&lt;</span> Node\n  attr_reader <span class=\"token symbol\">:constant_value</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">parse</span></span><span class=\"token operator\">!</span>\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'unexepected, got %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">CONST</span>\n\n    <span class=\"token variable\">@constant_value</span> <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>value\n\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'expected terminator, got %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">TERM</span>\n\n    <span class=\"token keyword\">self</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Function</span> <span class=\"token operator\">&lt;</span> Node\n  attr_reader <span class=\"token symbol\">:return_type</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:id</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:statements</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">parse</span></span><span class=\"token operator\">!</span>\n    <span class=\"token variable\">@statements</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n\n    <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">KEYWORD</span> <span class=\"token operator\">&amp;&amp;</span> return_types<span class=\"token punctuation\">.</span><span class=\"token keyword\">include</span><span class=\"token operator\">?</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'invalid function return type %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token variable\">@return_type</span> <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>value\n\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'expected function name, got %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">ID</span>\n\n    <span class=\"token variable\">@id</span> <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>value\n\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'expected args, got %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">PAREN</span>\n\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'expected args, got %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">END_PAREN</span>\n\n    token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'expected args, got %&lt;type>s : %&lt;value>s'</span></span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>token<span class=\"token punctuation\">)</span> <span class=\"token keyword\">unless</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">BLOCK</span>\n\n    loop <span class=\"token keyword\">do</span>\n      <span class=\"token keyword\">if</span> token<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> Token<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">END_BLOCK</span>\n        <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'missing return'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token variable\">@statements</span><span class=\"token punctuation\">.</span>empty<span class=\"token operator\">?</span>\n\n        <span class=\"token keyword\">break</span>\n      <span class=\"token keyword\">end</span>\n\n      <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">'unexpected end of function'</span></span> <span class=\"token keyword\">if</span> tokens<span class=\"token punctuation\">.</span>empty<span class=\"token operator\">?</span>\n\n      <span class=\"token variable\">@statements</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">Statement</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parse<span class=\"token operator\">!</span>\n\n      <span class=\"token keyword\">raise</span> ParseError<span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">'unexpected end of function'</span></span> <span class=\"token keyword\">if</span> tokens<span class=\"token punctuation\">.</span>empty<span class=\"token operator\">?</span>\n\n      token <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span>shift\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token keyword\">self</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">return_types</span></span>\n    <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'int'</span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Parse</span>\n  attr_reader <span class=\"token symbol\">:compiler</span>\n  attr_accessor <span class=\"token symbol\">:curnode</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">initialize</span></span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">@compiler</span> <span class=\"token operator\">=</span> compiler\n    <span class=\"token variable\">@ast</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Program</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">.</span>tokens<span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">@curnode</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@ast</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">parse</span></span><span class=\"token operator\">!</span>\n    <span class=\"token variable\">@curnode</span><span class=\"token punctuation\">.</span>parse<span class=\"token operator\">!</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>I’m going to throw in the code generator here too, since (for now) it’s actually relatively simple. I’m reopening classes here, sorry. It’s work a work in progress.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># frozen_string_literal: true</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Function</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">compile</span></span><span class=\"token operator\">!</span>\n    <span class=\"token string-literal heredoc-string\"><span class=\"token delimiter\"><span class=\"token punctuation\">&lt;&lt;~</span><span class=\"token symbol\">ASM</span></span><span class=\"token string\">\n      .globl </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">id</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">id</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">:\n      </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">statements<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token symbol\">:compile!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"\\n\"</span></span><span class=\"token punctuation\">)</span></span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">\n    </span><span class=\"token delimiter\"><span class=\"token symbol\">ASM</span></span></span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Statement</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">compile</span></span><span class=\"token operator\">!</span>\n    <span class=\"token string-literal heredoc-string\"><span class=\"token delimiter\"><span class=\"token punctuation\">&lt;&lt;~</span><span class=\"token symbol\">ASM</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">expression<span class=\"token punctuation\">.</span>compile<span class=\"token operator\">!</span></span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">\n      </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">is_return <span class=\"token operator\">?</span> <span class=\"token string-literal\"><span class=\"token string\">'ret'</span></span> <span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">''</span></span></span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">\n    </span><span class=\"token delimiter\"><span class=\"token symbol\">ASM</span></span></span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Expression</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">compile</span></span><span class=\"token operator\">!</span>\n    <span class=\"token string-literal heredoc-string\"><span class=\"token delimiter\"><span class=\"token punctuation\">&lt;&lt;~</span><span class=\"token symbol\">ASM</span></span><span class=\"token string\">\n      movl    $</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">constant_value</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">, %eax\n    </span><span class=\"token delimiter\"><span class=\"token symbol\">ASM</span></span></span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Generate</span>\n  attr_reader <span class=\"token symbol\">:compiler</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">initialize</span></span><span class=\"token punctuation\">(</span>compiler<span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">@compiler</span> <span class=\"token operator\">=</span> compiler\n    <span class=\"token variable\">@buf</span> <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">''</span></span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">compile</span></span><span class=\"token operator\">!</span>\n    main <span class=\"token operator\">=</span> compiler<span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>function\n    main<span class=\"token punctuation\">.</span>compile<span class=\"token operator\">!</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>I’m a bit concerned how this will scale. It seems like the parsing of each node is <em>very</em> specific to that node. I guess it would be, I’m not sure what I’m trying to say here. I just assume what I’m doing here will break down quickly and stop working. We’ll see!</p>\n<p>I’m glad I made it this far, I’m curious to see how much more I can build on what I have here. Looking forward to <a href=\"https://norasandler.com/2017/12/05/Write-a-Compiler-2.html\">Part 2</a>.</p>","fields":{"slug":"/2021/11-26-compiler-parser/"},"frontmatter":{"title":"Writing a C Compiler: Part 2, Parser and Code Generation","date":"November 26, 2021","description":null}}},"pageContext":{"slug":"/2021/11-26-compiler-parser/","previous":{"fields":{"slug":"/2021/12-18-comiler-vars/"},"frontmatter":{"title":"Writing a C Compiler: Part 3, Variables"}},"next":{"fields":{"slug":"/2022/05-27-joystick-in-unity/"},"frontmatter":{"title":"How to fix joystick drift in Unity"}}}},
    "staticQueryHashes": ["1091219763","63159454"]}